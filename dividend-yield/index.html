<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>股票殖利率計算機</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      max-width: 800px;
      margin: auto;
    }
    label {
      display: block;
      margin: 1em 0 0.25em;
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 0.5em;
      font-size: 1em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2em;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    
    /* 新增股票查詢相關樣式 */
    .stock-search {
      margin: 1.5em 0;
      padding: 1em;
      background-color: #f9f9f9;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    
    .search-result {
      margin-top: 0.7em;
      font-weight: bold;
    }
    
    .search-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .search-row input {
      flex: 1;
      max-width: 150px;
    }
    
    .search-row button {
      padding: 0.5em 1em;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .search-row button:hover {
      background-color: #005fa3;
    }
    
    .error-message {
      color: #d32f2f;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div id="currentTime" style="text-align: right; font-size: 0.9em; color: #555;"></div>
  <button id="toggleDarkMode">切換亮模式</button>
  <h1>股票殖利率計算機</h1>

  <!-- 股票查詢區塊 -->
  <div class="stock-search">
    <h3>股票價格查詢</h3>
    <div class="search-row">
      <input type="text" id="stockCode" placeholder="輸入股票代碼" maxlength="6">
      <button id="searchButton">查詢股價</button>
    </div>
    <div class="search-result" id="searchResult"></div>
  </div>

  <label for="prices">除權息前股價（可輸入多個，以逗號分隔）</label>
  <input type="text" id="prices" placeholder="例如：22,21,20,19">

  <label for="cash">現金股利（元）</label>
  <input type="number" id="cash" step="0.01" value="0.91">

  <label for="stock">股票股利（元）</label>
  <input type="number" id="stock" step="0.01" value="0.34">

  <table id="resultTable" style="display:none;">
    <thead>
      <tr>
        <th>原始股價</th>
        <th>除權息後股價</th>
        <th>現金殖利率(%)</th>
        <th>股票殖利率(%)</th>
        <th>合計殖利率(%)</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>

  <script src="../theme.js"></script>
  <script src="../time.js"></script>
  <script src="../stock-price.js"></script>
  <script>
    const pricesInput = document.getElementById("prices");
    const cashInput = document.getElementById("cash");
    const stockInput = document.getElementById("stock");
    const resultTable = document.getElementById("resultTable");
    const resultBody = document.getElementById("resultBody");
    const stockCodeInput = document.getElementById("stockCode");
    const searchButton = document.getElementById("searchButton");
    const searchResult = document.getElementById("searchResult");

    // 新增股價查詢功能
    searchButton.addEventListener("click", async () => {
      const stockCode = formatStockCode(stockCodeInput.value);
      
      if (!stockCode || stockCode.length < 4) {
        searchResult.innerHTML = '<span class="error-message">請輸入有效的股票代碼</span>';
        return;
      }

      searchResult.textContent = "查詢中...";
      
      try {
        const result = await fetchStockPrice(stockCode);
        
        if (result.success) {
          searchResult.textContent = `${stockCode} - 目前股價：${result.price} 元`;
          
          // 將查詢到的股價加入輸入框
          if (pricesInput.value) {
            pricesInput.value += `, ${result.price}`;
          } else {
            pricesInput.value = result.price.toString();
          }
          
          // 觸發計算
          calculateAndDisplay();
        } else {
          searchResult.innerHTML = `<span class="error-message">${result.message}</span>`;
        }
      } catch (error) {
        searchResult.innerHTML = '<span class="error-message">查詢時發生錯誤，請稍後再試</span>';
      }
    });

    function calculateAndDisplay() {
      const priceValues = pricesInput.value.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v));
      const cash = parseFloat(cashInput.value);
      const stock = parseFloat(stockInput.value);

      if (!priceValues.length || isNaN(cash) || isNaN(stock)) {
        resultTable.style.display = "none";
        return;
      }

      resultBody.innerHTML = "";

      priceValues.forEach(price => {
        const stockYield = stock / (10 + stock) * 100;
        const cashYield = (cash / price) * 100;
        const adjustedPrice = (price - cash) / (1 + stock / 10);
        const totalYield = stockYield + cashYield;

        const row = `<tr>
          <td>${price.toFixed(2)}</td>
          <td>${adjustedPrice.toFixed(2)}</td>
          <td>${cashYield.toFixed(2)}</td>
          <td>${stockYield.toFixed(2)}</td>
          <td>${totalYield.toFixed(2)}</td>
        </tr>`;

        resultBody.innerHTML += row;
      });

      resultTable.style.display = "table";
    }

    pricesInput.addEventListener("input", calculateAndDisplay);
    cashInput.addEventListener("input", calculateAndDisplay);
    stockInput.addEventListener("input", calculateAndDisplay);
  </script>
</body>
</html>
